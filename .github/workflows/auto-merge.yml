name: Auto-merge bot PRs

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request'
    steps:
      - name: Merge PR if auto-update labeled
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.workflow_run.pull_requests[0].number }}
          REPO: ${{ github.repository }}
        run: |
          if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
            echo "No PR number found, skipping"
            exit 0
          fi

          AUTHOR=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json author --jq '.author.login')
          if [ "$AUTHOR" != "github-actions[bot]" ]; then
            echo "::warning::PR #$PR_NUMBER authored by '$AUTHOR', expected 'github-actions[bot]'. Skipping merge."
            exit 0
          fi

          LABEL=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json labels --jq '.labels[].name' | grep -c "auto-update" || true)
          if [ "$LABEL" -eq 0 ]; then
            echo "PR does not have auto-update label, skipping"
            exit 0
          fi

          gh pr merge "$PR_NUMBER" --repo "$REPO" --squash --delete-branch
